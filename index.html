<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ - Apache Superset Embed</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
</head>

<body class="transition-colors duration-300">
    <div id="app-container">
        <div class="toggle-controls" id="toggleControls">‚â°</div>
        
        <div class="background-text">
            <h1>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–æ–≥–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞</h1>
        </div>
        
        <div class="controls" id="controls">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫...">
            <span id="selectedCount">–í—ã–¥–µ–ª–µ–Ω–æ: 0</span>
            
            <button type="button" id="saveCloudBtn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
            <button type="button" id="loadCloudBtn">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
            <button type="button" id="shareLinkBtn">üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            
            <button type="button" id="jsonExportBtn">JSON –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button type="button" id="jsonImportBtn">JSON –ò–º–ø–æ—Ä—Ç</button>
            <button type="button" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
            <button type="button" id="collapseAllBtn">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <button type="button" id="collapseParentBtn">–°–≤–µ—Ä–Ω—É—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</button>
            <button type="button" id="addSuperordinateAboveBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—Ä—Ö—É</button>
            <button type="button" id="uploadFileBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
            
            <button type="button" id="mark269Btn">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ 269-–ü</button>
            <button type="button" id="power269Btn">–ü–æ–ª–Ω–æ–º–æ—á–∏–µ –∏–∑ 269-–ü</button>
            <button type="button" id="subordinateBtn">–î–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã</button>
            <button type="button" id="forAllBtn">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
            <button type="button" id="authorityBtn">–ò–¥–µ–Ω—Ç–∏—á–Ω–æ–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–µ</button>
            <button type="button" id="okrBtn">OKR</button>
            <button type="button" id="indicatorBtn">–ì–æ—Å. –ø—Ä–æ–≥—Ä–∞–º–º–∞</button>
            
            <select id="clusterSelect">
                <option value="">–í—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</option>
            </select>
            <button id="addToClusterBtn">üè∑Ô∏è</button>
            
            <button type="button" id="zoomInBtn">+</button>
            <button type="button" id="zoomResetBtn">‚≠ï</button>
            <button type="button" id="zoomOutBtn">-</button>
            
            <div class="theme-switch" id="themeSwitch">
                <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
                <span class="theme-icon moon-icon">üåô</span>
                <div class="theme-switch-handle"></div>
            </div>
        </div>
        
        <div class="drop-zone" id="dropZone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
        
        <div id="tree" class="tree">
            <div class="tree-loading" id="treeLoading">
                <div class="loading-spinner"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ä–µ–≤–∞...</p>
            </div>
        </div>
        
        <div class="watermark">Interactive Tree v9.2</div>
        <div class="history-log-icon" id="historyLogIcon">üïí</div>
    </div>

    <div id="app-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; justify-content: center; align-items: center; z-index: 9999;">
        <div style="text-align: center;">
            <div class="spinner" style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p style="font-size: 18px;">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...</p>
            <p id="load-status" style="font-size: 14px; color: #666;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è</p>
        </div>
    </div>

    <script>
    window.appState = {
        scriptsLoaded: 0,
        totalScripts: 6,
        isInitialized: false,
        hasError: false
    };

    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tree-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 50px;
            color: var(--text-color);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px;
            border: 1px solid #ffcdd2;
        }
        .retry-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    `;
    document.head.appendChild(style);

    function loadScript(src, isCritical = false) {
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.async = false; // –í–∞–∂–Ω–æ: –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            
            script.onload = () => {
                console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω: ${src}`);
                window.appState.scriptsLoaded++;
                updateLoaderStatus();
                resolve();
            };
            
            script.onerror = (error) => {
                console.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${src}`, error);
                
                if (isCritical) {
                    window.appState.hasError = true;
                    showCriticalError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${src}`);
                }
                
                reject(error);
            };
            
            document.body.appendChild(script);
        });
    }

    function updateLoaderStatus() {
        const status = document.getElementById('load-status');
        if (status) {
            const percent = Math.round((window.appState.scriptsLoaded / window.appState.totalScripts) * 100);
            status.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫—Ä–∏–ø—Ç–æ–≤: ${percent}%`;
        }
    }

    function showCriticalError(message) {
        const loader = document.getElementById('app-loader');
        if (loader) {
            loader.innerHTML = `
                <div style="text-align: center; padding: 30px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">‚ùå</div>
                    <h3 style="color: #c62828;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h3>
                    <p>${message}</p>
                    <div class="error-message" style="text-align: left; margin: 20px auto; max-width: 500px;">
                        <p><strong>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</strong></p>
                        <ol>
                            <li>–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)</li>
                            <li>–û—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –±—Ä–∞—É–∑–µ—Ä–∞</li>
                            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º</li>
                            <li>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–º</li>
                        </ol>
                    </div>
                    <button class="retry-button" onclick="location.reload()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>
                </div>
            `;
        }
    }

    function hideLoader() {
        const loader = document.getElementById('app-loader');
        if (loader) {
            loader.style.opacity = '0';
            loader.style.transition = 'opacity 0.5s';
            setTimeout(() => {
                loader.style.display = 'none';
            }, 500);
        }
    }

    function showTree() {
        const loading = document.getElementById('treeLoading');
        if (loading) {
            loading.style.display = 'none';
        }
    }
    async function initializeApp() {
        console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        
        try {
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û
            await loadScript('node-effects.js', true);
            await loadScript('indexed-db-manager.js', true);
            await loadScript('tree-manager-core.js', true);
            
            // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–ª–∞—á–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
            try {
                await loadScript('tree-storage.js');
            } catch (e) {
                console.warn('tree-storage.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–±–ª–∞—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
            
            try {
                await loadScript('tree-cloud.js');
            } catch (e) {
                console.warn('tree-cloud.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–±–ª–∞—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
            }
            
            // 3. –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç
            await loadScript('main.js', true);
            
            console.log('‚úÖ –í—Å–µ —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
            
            setTimeout(() => {
                if (typeof window.treeApp !== 'undefined' && typeof window.treeApp.initialize === 'function') {
                    window.treeApp.initialize();
                } else if (typeof initTreeApp === 'function') {
                    initTreeApp();
                }
                
                if (typeof window.initCloudStorage === 'function') {
                    setTimeout(() => {
                        window.initCloudStorage();
                    }, 1000);
                }
                
                showTree();
                
                setTimeout(hideLoader, 500);
                
                window.appState.isInitialized = true;
                console.log('‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
                
                checkAutoLoad();
                
            }, 100);
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
            showCriticalError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è');
        }
    }

    function checkAutoLoad() {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö...');
        
        const urlParams = new URLSearchParams(window.location.search);
        const hasTreeParam = urlParams.has('tree') || urlParams.has('data');
        
        const hasLocalData = localStorage.getItem('treeData');
        
        if (hasTreeParam || hasLocalData) {
            console.log('–ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏');
            
            if (typeof window.autoLoadTreeOnStart === 'function') {
                setTimeout(() => {
                    window.autoLoadTreeOnStart();
                }, 1500);
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
        initializeApp();
    });

    window.addEventListener('error', function(e) {
        console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', e.error);
    });

    setTimeout(() => {
        if (!window.appState.isInitialized && !window.appState.hasError) {
            console.log('‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º fallback...');
            
            setupFallbackControls();
        }
    }, 10000);

    function setupFallbackControls() {
        const saveCloudBtn = document.getElementById('saveCloudBtn');
        const loadCloudBtn = document.getElementById('loadCloudBtn');
        
        if (saveCloudBtn) {
            saveCloudBtn.onclick = () => alert('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ');
        }
        
        if (loadCloudBtn) {
            loadCloudBtn.onclick = () => {
                alert('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                try {
                    const data = localStorage.getItem('treeData');
                    if (data) {
                        try {
                            const treeData = JSON.parse(data);
                            showSimpleTree(treeData);
                        } catch (e) {
                            alert('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞–Ω–Ω—ã—Ö');
                        }
                    } else {
                        alert('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
                    }
                } catch (e) {
                    alert('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ö—Ä–∞–Ω–∏–ª–∏—â—É');
                }
            };
        }
    }

    function showSimpleTree(treeData) {
        const treeDiv = document.getElementById('tree');
        if (!treeDiv) return;
        
        let html = '<div class="simple-tree">';
        
        function buildTree(data, level = 0) {
            if (!data) return '';
            
            const name = data.name || data.title || '–≠–ª–µ–º–µ–Ω—Ç';
            const padding = level * 20;
            
            html += `<div style="margin-left: ${padding}px; padding: 5px; border-left: ${level > 0 ? '2px solid #ccc' : 'none'}">`;
            html += `<strong>${name}</strong>`;
            
            if (data.children && Array.isArray(data.children)) {
                data.children.forEach(child => {
                    buildTree(child, level + 1);
                });
            }
            
            html += '</div>';
        }
        
        buildTree(treeData);
        html += '</div>';
        treeDiv.innerHTML = html;
    }

    </script>
</body>
</html>
