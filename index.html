<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –¥–µ—Ä–µ–≤–æ - Apache Superset Embed</title>
    <meta http-equiv="Content-Security-Policy" 
          content="script-src 'self' https://cdn.jsdelivr.net;
                   style-src 'self' 'unsafe-inline';
                   img-src 'self' data: blob:;">
    
    <link rel="stylesheet" href="styles.css">
    
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"></script>
    
</head>

<body class="transition-colors duration-300">
    <div class="toggle-controls" id="toggleControls">‚â°</div>
    
    <div class="background-text">
        <h1>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ—Ç–Ω–æ—à–µ–Ω–∏–π –Ø–º–∞–ª–æ-–ù–µ–Ω–µ—Ü–∫–æ–≥–æ –∞–≤—Ç–æ–Ω–æ–º–Ω–æ–≥–æ –æ–∫—Ä—É–≥–∞</h1>
    </div>
    
    <div class="controls" id="controls">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color);">
        <span id="selectedCount" style="margin-left: 10px; font-size: 0.9em; color: var(--accent-color); display: none;">–í—ã–¥–µ–ª–µ–Ω–æ: 0</span>
        <div class="autocomplete-suggestions" id="searchSuggestions"></div>
        <button type="button" id="saveCloudBtn" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–µ—Ä–µ–≤–æ –≤ GitHub">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
        <button type="button" id="loadCloudBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ä–µ–≤–æ –∏–∑ GitHub">‚òÅÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
        <button type="button" id="shareLinkBtn" title="–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É –¥–ª—è –∫–æ–ª–ª–µ–≥">üîó –°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <div style="width: 1px; height: 20px; background: var(--border-color); margin: 0 5px;"></div>
        <button type="button" id="jsonExportBtn">JSON –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button type="button" id="jsonImportBtn">JSON –ò–º–ø–æ—Ä—Ç</button>
        <button type="button" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ</button>
        
        <button type="button" id="collapseAllBtn">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        <button type="button" id="collapseParentBtn" class="collapse-parent-btn">–°–≤–µ—Ä–Ω—É—Ç—å —Ä–æ–¥–∏—Ç–µ–ª—è</button>
        
        <button type="button" id="addSuperordinateAboveBtn">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—Ä—Ö—É</button>
        <button type="button" id="uploadFileBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        
        <button type="button" id="mark269Btn">–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ 269-–ü</button>
        <button type="button" id="power269Btn">–ü–æ–ª–Ω–æ–º–æ—á–∏–µ –∏–∑ 269-–ü</button>
        <button type="button" id="subordinateBtn">–î–æ–ª–∂–Ω–æ—Å—Ç–Ω—ã–µ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç—ã</button>
        <button type="button" id="forAllBtn">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</button>
        <button type="button" id="authorityBtn">–ò–¥–µ–Ω—Ç–∏—á–Ω–æ–µ –ø–æ–ª–Ω–æ–º–æ—á–∏–µ</button>
        <button type="button" id="okrBtn">OKR</button>
        <button type="button" id="indicatorBtn">–ì–æ—Å. –ø—Ä–æ–≥—Ä–∞–º–º–∞</button>
        <div class="cluster-controls" style="display: flex; gap: 5px; align-items: center;">
            <select id="clusterSelect" style="padding: 8px; border-radius: 8px; border: 1px solid var(--primary-color); background: var(--controls-bg); color: var(--text-color);">
                <option value="">–í—Å—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞</option>
            </select>
            <button id="addToClusterBtn" title="–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Ç–µ—Ä">üè∑Ô∏è</button>
        </div>
        <button type="button" id="zoomInBtn">+</button>
        <button type="button" id="zoomResetBtn" class="reset-zoom-btn" title="–°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–± –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º —É–∑–ª–µ">‚≠ï</button>
        <button type="button" id="zoomOutBtn">-</button>
        <div class="theme-switch" id="themeSwitch">
            <span class="theme-icon sun-icon">‚òÄÔ∏è</span>
            <span class="theme-icon moon-icon">üåô</span>
            <div class="theme-switch-handle"></div>
            <div class="theme-transition-overlay" id="themeTransitionOverlay"></div>
        </div>
    </div>
    
    <div class="drop-zone" id="dropZone">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</div>
    <div id="tree" class="tree"></div>
    
    <div class="image-preview-container" id="previewContainer">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" class="image-preview" id="fullPreview">
    </div>
    
    <div class="watermark">Interactive Tree v9.2</div>
    <div class="history-log-icon" id="historyLogIcon" title="–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">üïí</div>
    
    <div class="history-dialog-backdrop" id="historyDialogBackdrop">
        <div class="history-dialog">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
            <ul class="history-list" id="historyList"></ul>
            <button class="history-dialog-close" id="historyDialogClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
    
    <div class="department-management" id="departmentManagement">
        <div class="department-header">
            <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª–∞–º–∏</h2>
            <button id="closeDepartmentManagement">√ó –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="department-container" id="departmentContainer"></div>
    </div>
    
    <div id="tooltip-container" class="tooltip" style="display: none;"></div>
    <script src="node-effects.js"></script>
    <script src="indexed-db-manager.js"></script>
    <script src="tree-manager-core.js"></script>
    <script src="tree-storage.js"></script>
    <script src="tree-cloud.js"></script>
    <script src="main.js"></script>
    <script>
    (function() {
        const isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
        if (isChrome && parseInt(navigator.userAgent.match(/Chrome\/(\d+)/)?.[1] || 0) < 50) {
            console.warn('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏');
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #ff9800;
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    z-index: 10000;
                    max-width: 300px;
                `;
                notification.textContent = '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é –±—Ä–∞—É–∑–µ—Ä–∞';
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
            }, 1000);
        }
        function checkAndLoadPolyfills() {
            const polyfills = [];
            
            if (!window.Promise) {
                polyfills.push('Promise');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js';
                document.head.appendChild(script);
            }
            
            if (!window.fetch) {
                polyfills.push('fetch');
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js';
                document.head.appendChild(script);
            }
            
            if (polyfills.length > 0) {
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ª–∏—Ñ–∏–ª–ª—ã:', polyfills.join(', '));
            }
        }
        setTimeout(checkAndLoadPolyfills, 100);
        if (window.treeApp) {
            window.treeApp.initialize();
        }
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (window.initCloudStorage) {
                    initCloudStorage();
                }
                const saveCloudBtn = document.getElementById('saveCloudBtn');
                const loadCloudBtn = document.getElementById('loadCloudBtn');
                const shareLinkBtn = document.getElementById('shareLinkBtn');
                
                if (saveCloudBtn) {
                    saveCloudBtn.addEventListener('click', function(e) {
                        if (window.saveTreeToCloud) {
                            saveTreeToCloud.call(this, e);
                        } else {
                            console.error('–§—É–Ω–∫—Ü–∏—è saveTreeToCloud –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            alert('–û–±–ª–∞—á–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É tree-cloud.js');
                        }
                    });
                }
                
                if (loadCloudBtn) {
                    loadCloudBtn.addEventListener('click', function(e) {
                        if (window.loadTreeFromCloud) {
                            loadTreeFromCloud.call(this, e);
                        } else {
                            console.error('–§—É–Ω–∫—Ü–∏—è loadTreeFromCloud –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            alert('–û–±–ª–∞—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É tree-cloud.js');
                        }
                    });
                }
                
                if (shareLinkBtn) {
                    shareLinkBtn.addEventListener('click', function(e) {
                        if (window.shareTreeLink) {
                            shareTreeLink.call(this, e);
                        } else {
                            console.error('–§—É–Ω–∫—Ü–∏—è shareTreeLink –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                            alert('–°–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É tree-cloud.js');
                        }
                    });
                }
                setTimeout(function() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const treeParam = urlParams.get('tree');
                    const dataParam = urlParams.get('data');
                    
                    if ((treeParam || dataParam) && window.autoLoadTreeOnStart) {
                        console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤ URL, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É...');
                        autoLoadTreeOnStart();
                    }
                }, 2000);
                
            }, 1500);
        });
        window.debugCloudStorage = function() {
            console.log('=== –û—Ç–ª–∞–¥–∫–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ ===');
            console.log('TreeStorage –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof TreeStorage !== 'undefined');
            console.log('treeStorage –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω:', typeof treeStorage !== 'undefined');
            console.log('saveTreeToCloud –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof saveTreeToCloud === 'function');
            console.log('loadTreeFromCloud –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof loadTreeFromCloud === 'function');
            console.log('shareTreeLink –¥–æ—Å—Ç—É–ø–Ω–∞:', typeof shareTreeLink === 'function');
            console.log('LZString –¥–æ—Å—Ç—É–ø–µ–Ω:', typeof LZString !== 'undefined');
            console.log('–¢–æ–∫–µ–Ω –≤ localStorage:', localStorage.getItem('githubToken'));
            if (window.getCurrentTreeData) {
                const treeData = getCurrentTreeData();
                console.log('–¢–µ–∫—É—â–µ–µ –¥–µ—Ä–µ–≤–æ:', treeData);
                console.log('–†–∞–∑–º–µ—Ä –¥–µ—Ä–µ–≤–∞ (—Å–∏–º–≤–æ–ª–æ–≤):', JSON.stringify(treeData).length);
            }
            
            const urlParams = new URLSearchParams(window.location.search);
            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä tree –≤ URL:', urlParams.get('tree') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
            console.log('–ü–∞—Ä–∞–º–µ—Ç—Ä data –≤ URL:', urlParams.get('data') ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
            if (typeof LZString !== 'undefined') {
                const testData = { test: 'Hello World' };
                const compressed = LZString.compressToEncodedURIComponent(JSON.stringify(testData));
                console.log('–¢–µ—Å—Ç —Å–∂–∞—Ç–∏—è LZString:', {
                    –æ—Ä–∏–≥–∏–Ω–∞–ª: JSON.stringify(testData).length,
                    —Å–∂–∞—Ç—ã–π: compressed.length,
                    –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: (JSON.stringify(testData).length / compressed.length).toFixed(2)
                });
            }
        };
        
    })();
    </script>
</body>
</html>
